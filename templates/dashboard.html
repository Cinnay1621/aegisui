<!-- aegisui/templates/dashboard.html -->
{% extends "base.html" %}
{% if current_project_name %}
<div class="row mb-3">
  <div class="col">
    <strong>Aktives Projekt:</strong> {{ current_project_name }}
  </div>
</div>
{% endif %}

{% block content %}
<form method="get" action="{{ url_for('dashboard') }}" class="mb-3">
  <div class="row g-2 align-items-center">
    <div class="col-auto">
      <strong>Aktives Projekt:</strong>
    </div>
    <div class="col-auto">
      <select name="project_id" class="form-control" onchange="this.form.submit()">
        {% for pr in projects %}
          <option value="{{ pr['id'] }}" {% if current_project_id == pr['id'] %}selected{% endif %}>{{ pr['name'] }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      {% if can_edit_current_project %}
      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('project_settings', project_id=current_project_id) }}">Bearbeiten</a>
      {% endif %}
    </div>
  </div>
</form>

<div class="row g-4">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header">
        Pipelines
      </div>
      <div class="card-body">
        <form method="post" action="{{ url_for('create_pipeline') }}">
          <div class="row g-2 mb-3">
            <div class="col-md-4">
              <input class="form-control" name="name" placeholder="Name" required {% if user and user.role != 'admin' %}disabled{% endif %}>
            </div>
            <div class="col-md-4">
              <input class="form-control" name="playbook_path" placeholder="Playbook Pfad" required {% if user and user.role != 'admin' %}disabled{% endif %}>
            </div>
            <div class="col-md-4">
              <input class="form-control" name="inventory_path" placeholder="Inventory Pfad" required {% if user and user.role != 'admin' %}disabled{% endif %}>
            </div>
          </div>
          <div class="row g-2 mb-3">
            <div class="col-md-8">
              <input class="form-control" name="extra_vars_path" placeholder="Extra Vars Pfad (optional)" {% if user and user.role != 'admin' %}disabled{% endif %}>
            </div>
            <div class="col-md-4">
              <button class="btn btn-primary" type="submit" {% if not user or user.role != 'admin' %}disabled{% endif %}>Pipeline hinzufügen</button>
            </div>
          </div>
        </form>

        <hr>
        <table class="table table-striped table-sm">
          <thead><tr><th>Name</th><th>Playbook</th><th>Inventory</th><th>Extra Vars</th><th>Erstellt</th><th>Aktionen</th></tr></thead>
          <tbody>
          {% for p in pipelines %}
            <tr>
              <td>{{ p['name'] }}</td>
              <td title="{{ p['playbook_path'] }}">{{ p['playbook_path'][:40] }}{% if p['playbook_path']|length > 40 %}...{% endif %}</td>
              <td title="{{ p['inventory_path'] }}">{{ p['inventory_path'][:40] }}{% if p['inventory_path']|length > 40 %}...{% endif %}</td>
              <td>{{ (p['extra_vars_path'] or '')|truncate(30) }}</td>
              <td>{{ p['created_at'] }}</td>
              <td>
                <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('view_pipeline', pipeline_id=p['id']) }}">Details</a>
                <a class="btn btn-sm btn-outline-primary" href="{{ url_for('run_pipeline', pipeline_id=p['id']) }}" {% if not p.can_run %}style="pointer-events:none;opacity:.5"{% endif %}>Ausführen</a>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card">
      <div class="card-header">
        Letzte Jobs
      </div>
      <div class="card-body p-2">
        <table class="table table-sm">
          <thead><tr><th>Job</th><th>Pipeline</th><th>Status</th><th>Started</th><th>Ended</th></tr></thead>
          <tbody>
            {% for j in recent_jobs %}
            <tr>
              <td>#{{ j['id'] }}</td>
              <td>{{ j['pipeline_id'] }}</td>
              <td>{{ j['status'] }}</td>
              <td>{{ j['started_at'] }}</td>
              <td>{{ j['ended_at'] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}